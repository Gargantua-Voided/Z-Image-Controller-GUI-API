<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Image Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b;
            color: #e4e4e7;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
<script type="importmap">
{
  "imports": {
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="antialiased">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="border-b border-zinc-800 bg-zinc-900/50 backdrop-blur-md sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/20">
                        <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
                    </div>
                    <h1 class="font-bold text-xl tracking-tight text-white">Z-Image Controller</h1>
                </div>

                <div class="flex items-center gap-4">
                    <button onclick="toggleSetup()" class="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-colors text-zinc-400 hover:text-white hover:bg-zinc-800">
                        <i data-lucide="terminal-square" class="w-4 h-4"></i>
                        Server Setup
                    </button>
                    <div id="status-badge" class="flex items-center gap-2 px-3 py-1.5 rounded-full border text-sm font-medium bg-rose-500/10 border-rose-500/20 text-rose-500 transition-all duration-300">
                        <i data-lucide="wifi-off" class="w-3.5 h-3.5"></i>
                        Disconnected
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 max-w-7xl w-full mx-auto p-4 md:p-6 lg:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
                
                <!-- Left Column: Controls -->
                <div class="lg:col-span-4 flex flex-col gap-4">
                    
                    <!-- Prompt Section -->
                    <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 flex flex-col gap-3 shadow-lg">
                        <label class="text-sm font-semibold text-zinc-300 flex items-center gap-2">
                            <i data-lucide="type" class="w-4 h-4 text-indigo-400"></i> Prompt
                        </label>
                        <textarea id="prompt-input" 
                            placeholder="Describe your image..."
                            class="w-full h-32 bg-zinc-950 border border-zinc-800 rounded-lg p-3 text-sm text-zinc-200 placeholder-zinc-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none transition-all"
                        >Young Chinese woman in red Hanfu, intricate embroidery. Impeccable makeup, red floral forehead pattern. Elaborate high bun, golden phoenix headdress, red flowers, beads. Holds round folding fan with lady, trees, bird. Neon lightning-bolt lamp (⚡️), bright yellow glow, above extended left palm. Soft-lit outdoor night background, silhouetted tiered pagoda (西安大雁塔), blurred colorful distant lights.</textarea>
                        
                        <button id="generate-btn" onclick="generateImage()" class="w-full py-3 px-4 rounded-lg font-semibold text-white shadow-lg transition-all flex items-center justify-center gap-2 bg-zinc-800 cursor-not-allowed opacity-50">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            <span>Generate Image</span>
                        </button>
                        <p id="error-msg" class="text-xs text-rose-500 text-center hidden"></p>
                    </div>

                    <!-- Settings Section -->
                    <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 flex-1 flex flex-col gap-6">
                        <div class="flex items-center gap-2 text-zinc-100 font-semibold text-lg border-b border-zinc-800 pb-4">
                            <i data-lucide="sliders" class="w-5 h-5 text-indigo-500"></i>
                            <span>Settings</span>
                        </div>

                        <!-- Dimensions -->
                        <div class="space-y-4">
                            <label class="text-sm font-medium text-zinc-400 flex items-center gap-2">
                                <i data-lucide="maximize" class="w-4 h-4"></i> Dimensions
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <span class="text-xs text-zinc-500 mb-1 block">Width</span>
                                    <select id="width-input" class="w-full bg-zinc-800 border border-zinc-700 text-zinc-200 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="512">512px</option>
                                        <option value="768">768px</option>
                                        <option value="1024" selected>1024px</option>
                                        <option value="1280">1280px</option>
                                    </select>
                                </div>
                                <div>
                                    <span class="text-xs text-zinc-500 mb-1 block">Height</span>
                                    <select id="height-input" class="w-full bg-zinc-800 border border-zinc-700 text-zinc-200 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="512">512px</option>
                                        <option value="768">768px</option>
                                        <option value="1024" selected>1024px</option>
                                        <option value="1280">1280px</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Steps -->
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <label class="text-sm font-medium text-zinc-400 flex items-center gap-2">
                                    <i data-lucide="zap" class="w-4 h-4"></i> Steps: <span id="steps-val" class="text-white">9</span>
                                </label>
                            </div>
                            <input type="range" id="steps-input" min="1" max="50" value="9" 
                                oninput="document.getElementById('steps-val').innerText = this.value"
                                class="w-full accent-indigo-500 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
                            <p class="text-xs text-zinc-500">Recommended 4-10 for Turbo models.</p>
                        </div>

                        <!-- Guidance -->
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <label class="text-sm font-medium text-zinc-400 flex items-center gap-2">
                                    <i data-lucide="scale" class="w-4 h-4"></i> Guidance: <span id="guidance-val" class="text-white">0.0</span>
                                </label>
                            </div>
                            <input type="range" id="guidance-input" min="0" max="10" step="0.1" value="0.0" 
                                oninput="document.getElementById('guidance-val').innerText = this.value"
                                class="w-full accent-indigo-500 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
                            <p class="text-xs text-zinc-500">Keep at 0.0 for Z-Image Turbo.</p>
                        </div>

                        <!-- Seed -->
                        <div class="space-y-3">
                            <label class="text-sm font-medium text-zinc-400 flex items-center gap-2">
                                <i data-lucide="hash" class="w-4 h-4"></i> Seed
                            </label>
                            <div class="flex gap-2">
                                <input type="number" id="seed-input" value="42" class="w-full bg-zinc-800 border border-zinc-700 text-zinc-200 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <button onclick="document.getElementById('seed-input').value = Math.floor(Math.random() * 1000000)" class="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-zinc-300 p-2 rounded transition-colors" title="Random Seed">
                                    <i data-lucide="shuffle" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Image Display -->
                <div class="lg:col-span-8">
                    <div id="image-container" class="w-full h-[calc(100vh-10rem)] bg-zinc-900/30 border border-zinc-800/50 rounded-2xl overflow-hidden relative group flex items-center justify-center">
                        <!-- Placeholder -->
                        <div id="placeholder" class="text-center p-8 flex flex-col items-center">
                            <div class="w-24 h-24 rounded-full bg-zinc-800/50 flex items-center justify-center mb-4">
                                <i data-lucide="image" class="w-12 h-12 text-zinc-600"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-zinc-300 mb-2">Ready to Create</h3>
                            <p class="text-zinc-500 max-w-sm">Connect the backend and click Generate to start.</p>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="loading" class="hidden absolute inset-0 bg-black/50 backdrop-blur-sm flex flex-col items-center justify-center z-20">
                            <div class="w-12 h-12 border-4 border-indigo-500/30 border-t-indigo-500 rounded-full animate-spin mb-4"></div>
                            <p class="text-indigo-400 font-medium animate-pulse">Generating...</p>
                        </div>

                        <!-- Result Image -->
                        <img id="result-image" class="hidden max-w-full max-h-full object-contain shadow-2xl z-10" alt="Generated Image" />
                        
                        <!-- Overlay Actions -->
                        <div id="image-actions" class="hidden absolute top-4 right-4 flex gap-2 z-20">
                            <a id="download-link" href="#" download="z-image.png" class="bg-black/70 hover:bg-black text-white p-2.5 rounded-lg backdrop-blur-sm border border-white/10 transition-colors">
                                <i data-lucide="download" class="w-5 h-5"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Setup Modal -->
        <div id="setup-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl animate-in fade-in zoom-in-95 duration-200">
                <div class="flex items-center justify-between p-6 border-b border-zinc-800">
                    <div class="flex items-center gap-3">
                        <i data-lucide="server" class="w-6 h-6 text-emerald-500"></i>
                        <h2 class="text-xl font-bold text-white">Local Server Setup</h2>
                    </div>
                    <button onclick="toggleSetup()" class="text-zinc-400 hover:text-white transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="p-6 overflow-y-auto space-y-6">
                    <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-lg text-blue-400 text-sm">
                        <p class="flex gap-2">
                            <i data-lucide="info" class="w-5 h-5 flex-shrink-0"></i>
                            This script will automatically check for and install all required dependencies (Flask, Torch, Diffusers, etc.) when you run it. If you want to use CUDA run this before starting the app:
                            pip install torch --index-url https://download.pytorch.org/whl/cu121
                            Works fine for 3090 Ti Python 3.10.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-center text-sm">
                            <label class="flex items-center gap-2 text-zinc-300 font-medium">
                                <i data-lucide="file-code" class="w-4 h-4"></i> app.py
                            </label>
                            <button onclick="copyCode()" id="copy-btn" class="flex items-center gap-2 px-3 py-1.5 rounded bg-zinc-800 hover:bg-zinc-700 text-zinc-300 transition-colors text-xs font-medium border border-zinc-700">
                                <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                Copy Code
                            </button>
                        </div>
                        <div class="relative group">
                            <pre id="code-block" class="bg-black/50 p-4 rounded-lg border border-zinc-800 text-xs text-zinc-300 font-mono overflow-x-auto h-96 select-all"></pre>
                        </div>
                    </div>

                    <div class="bg-zinc-800/50 p-4 rounded border border-zinc-700/50 text-sm text-zinc-300">
                        <p class="font-semibold mb-2">Instructions:</p>
                        <ol class="list-decimal list-inside space-y-1 text-zinc-400 ml-1">
                            <li>Create a file named <code class="bg-black/30 px-1.5 py-0.5 rounded text-zinc-200">app.py</code> in a new folder.</li>
                            <li>Paste the code above into it.</li>
                            <li>Run <code class="bg-black/30 px-1.5 py-0.5 rounded text-zinc-200">python app.py</code> in your terminal.</li>
                            <li>Wait for installation and model loading to complete.</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Python Code Template -->
    <script>
        const PYTHON_CODE = `import subprocess
import sys
import importlib
import os

# --- Dependency Management ---
# Automatically install packages if they are missing
packages = {
    "flask": "flask",
    "flask_cors": "flask-cors",
    "diffusers": "git+https://github.com/huggingface/diffusers",
    "transformers": "transformers",
    "accelerate": "accelerate",
    "google.protobuf": "protobuf",
    "sentencepiece": "sentencepiece"
}

def install_packages():
    print("--- Checking and Installing Dependencies ---")
    for module, package in packages.items():
        try:
            importlib.import_module(module)
        except ImportError:
            print(f"Installing {package}...")
            subprocess.check_call([sys.executable, "-m", "pip", "install", package])
    print("--- Dependencies Ready ---")

try:
    install_packages()
except Exception as e:
    print(f"Error installing packages: {e}")
    sys.exit(1)

# --- Application ---
import torch
from flask import Flask, request, jsonify
from flask_cors import CORS
from diffusers import ZImagePipeline
from io import BytesIO
import base64

app = Flask(__name__)
CORS(app)

DEVICE = "cuda" if torch.cuda.is_available() else "cpu"
DTYPE = torch.bfloat16 if DEVICE == "cuda" else torch.float32

print(f"\\n[INIT] Loading Z-Image Pipeline on {DEVICE}...")

try:
    pipe = ZImagePipeline.from_pretrained(
        "Tongyi-MAI/Z-Image-Turbo",
        torch_dtype=DTYPE,
        low_cpu_mem_usage=False,
    )
    pipe.to(DEVICE)
    if DEVICE == "cuda":
        try:
            pipe.transformer.set_attention_backend("flash")
        except:
            pass
    print("[INIT] Pipeline Loaded Successfully.\\n")
except Exception as e:
    print(f"[ERROR] Failed to load pipeline: {e}")
    pipe = None

@app.route('/health', methods=['GET'])
def health():
    return jsonify({"status": "ok", "loaded": pipe is not None})

@app.route('/generate', methods=['POST'])
def generate():
    if not pipe:
        return jsonify({"error": "Model not loaded."}), 500

    data = request.json
    print(f"[REQ] Generating: {data.get('prompt')[:50]}...")
    
    try:
        generator = torch.Generator(DEVICE).manual_seed(int(data.get("seed", 42)))
        image = pipe(
            prompt=data.get("prompt"),
            height=int(data.get("height", 1024)),
            width=int(data.get("width", 1024)),
            num_inference_steps=int(data.get("steps", 9)),
            guidance_scale=float(data.get("guidance", 0.0)),
            generator=generator
        ).images[0]

        buffered = BytesIO()
        image.save(buffered, format="PNG")
        img_str = base64.b64encode(buffered.getvalue()).decode("utf-8")
        
        return jsonify({"image": f"data:image/png;base64,{img_str}"})
    except Exception as e:
        print(f"[ERROR] {e}")
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    print("Server running on http://127.0.0.1:5000")
    app.run(host='0.0.0.0', port=5000)`;

        // --- Frontend Logic ---
        
        const API_URL = 'http://127.0.0.1:5000';
        let isConnected = false;
        let isGenerating = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            document.getElementById('code-block').textContent = PYTHON_CODE;
            
            // Start Health Check Polling
            checkHealth();
            setInterval(checkHealth, 5000);
            
            // Show setup initially if not connected
            setTimeout(() => {
                if(!isConnected) toggleSetup(true);
            }, 1000);
        });

        // Toggle Setup Modal
        function toggleSetup(show) {
            const modal = document.getElementById('setup-modal');
            if (show === undefined) {
                modal.classList.toggle('hidden');
            } else {
                if(show) modal.classList.remove('hidden');
                else modal.classList.add('hidden');
            }
        }

        // Copy Code Functionality
        function copyCode() {
            navigator.clipboard.writeText(PYTHON_CODE);
            const btn = document.getElementById('copy-btn');
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5 text-emerald-500"></i> Copied';
            lucide.createIcons();
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }, 2000);
        }

        // Health Check
        async function checkHealth() {
            try {
                const res = await fetch(`${API_URL}/health`);
                if (res.ok) {
                    isConnected = true;
                    updateStatus(true);
                } else {
                    isConnected = false;
                    updateStatus(false);
                }
            } catch (e) {
                isConnected = false;
                updateStatus(false);
            }
        }

        function updateStatus(connected) {
            const badge = document.getElementById('status-badge');
            const btn = document.getElementById('generate-btn');
            
            if (connected) {
                badge.className = "flex items-center gap-2 px-3 py-1.5 rounded-full border text-sm font-medium bg-emerald-500/10 border-emerald-500/20 text-emerald-500 transition-all duration-300";
                badge.innerHTML = '<i data-lucide="wifi" class="w-3.5 h-3.5"></i> Connected';
                if (!isGenerating) {
                    btn.classList.remove('bg-zinc-800', 'cursor-not-allowed', 'opacity-50');
                    btn.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
                    btn.disabled = false;
                }
            } else {
                badge.className = "flex items-center gap-2 px-3 py-1.5 rounded-full border text-sm font-medium bg-rose-500/10 border-rose-500/20 text-rose-500 transition-all duration-300";
                badge.innerHTML = '<i data-lucide="wifi-off" class="w-3.5 h-3.5"></i> Disconnected';
                btn.classList.add('bg-zinc-800', 'cursor-not-allowed', 'opacity-50');
                btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
                btn.disabled = true;
            }
            lucide.createIcons();
        }

        // Generate Image
        async function generateImage() {
            if (!isConnected || isGenerating) return;

            const prompt = document.getElementById('prompt-input').value;
            if (!prompt) return;

            isGenerating = true;
            const btn = document.getElementById('generate-btn');
            const loading = document.getElementById('loading');
            const placeholder = document.getElementById('placeholder');
            const resultImg = document.getElementById('result-image');
            const errorMsg = document.getElementById('error-msg');
            const actions = document.getElementById('image-actions');

            // UI State: Loading
            btn.disabled = true;
            btn.innerHTML = '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> Generating...';
            btn.classList.add('opacity-75');
            loading.classList.remove('hidden');
            placeholder.classList.add('hidden');
            resultImg.classList.add('hidden');
            actions.classList.add('hidden');
            errorMsg.classList.add('hidden');

            const payload = {
                prompt: prompt,
                width: parseInt(document.getElementById('width-input').value),
                height: parseInt(document.getElementById('height-input').value),
                steps: parseInt(document.getElementById('steps-input').value),
                guidance: parseFloat(document.getElementById('guidance-input').value),
                seed: parseInt(document.getElementById('seed-input').value)
            };

            try {
                const res = await fetch(`${API_URL}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.image) {
                    resultImg.src = data.image;
                    resultImg.classList.remove('hidden');
                    document.getElementById('download-link').href = data.image;
                    actions.classList.remove('hidden');
                } else {
                    throw new Error(data.error || "Unknown error");
                }
            } catch (err) {
                errorMsg.textContent = `Error: ${err.message}`;
                errorMsg.classList.remove('hidden');
                placeholder.classList.remove('hidden');
            } finally {
                isGenerating = false;
                loading.classList.add('hidden');
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> <span>Generate Image</span>';
                btn.classList.remove('opacity-75');
                lucide.createIcons();
            }
        }
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>